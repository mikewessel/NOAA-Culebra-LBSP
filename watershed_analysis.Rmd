---
title: "Watershed_Analysis"
author: "Mwessel"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE)
library(googlesheets4)
library(googledrive)
library(ggplot2)
library(dplyr)
library(psych)
library(tidyverse)
library(rlang)
library(knitr)
library(lubridate)
library(kableExtra)
library(forcats)
library(reshape2)

rm(list = ls())
```



```{r WSlab}

# read in watershed lab nutrients and bacteria datasheet 
rawdat<-data.frame(read_sheet("https://docs.google.com/spreadsheets/d/1qWWiaY-w2_Z-NJINq-mnOCpXk_fTmuQxA0sgXArYbgg/edit?usp=sharing"),  col_types = 'cDccccccccccccccccc')%>% # c=character D=Date
rename(
 Site.ID = Sample.ID,  
 Monochlorine.mgl = Monochorine..mg.l.  ,        
 NH4.mgl = Total.Ammonium..NH4.mg.l.  ,          
 NO3.mgl = Nitrate..NO3.mg.l. ,                  
 TN.mgl = Total.Nitrogen...TN.mg.l.,             
 Flow.gsec  = Flow..gal.sec. ,                   
 Ecoli.100ml = Escherichia..Coli..100ml.,        
 Date = Date.of.Monitoring,                      
 NO2.mgl = Nitrite...NO2.mg.l.,                  
 NH3.mgl = Free.Ammonia..NH3.mg.l.,              
 OP.mgl = Orthophosphate..OP.mg.l.,              
 TKN.mgl = Total.Kjeldahl.Nitrogen..TKN.mg.l.,   
 Fcoli.100ml = Fecal.Coliform..100ml.
   )%>%
mutate(Month=month(Date),Year=year(Date),Time2=format(strptime(Time, "%Y-%m-%d %H:%M:%S"),"%H:%M"))

```


Identify qualifiers and list samples omitted from analysis
```{r WSfield}
# read in googlesheet
wsfield<-data.frame(read_sheet("https://docs.google.com/spreadsheets/d/1QA9c1yXKe87fepSy2IrKXdG5lwptLW3lu7fKk-ahDsc/edit?usp=sharing"))%>%
rename(
Date = Date.of.Monitoring             ,
Date.Time = Sample.Time                    ,
Collected.by =Samples.collected.by.   ,
Entered.by =Data.entered.by.          ,
Site.ID = Sample.ID                   ,
Temp.c = Temperature...C.             ,
#Conductivity = Conductivity..ÂµS.cm.   ,
DO.mgl = DO..mg.l                     ,
DO.sat = DO....Saturation.            ,
Chla.blue = Chl.a..blue..ug.l.        ,
CDOM = CDOM..ppb.                     ,
Chla.red = Chla.Red..ug.l.            ,
Turb.ntu = Turbidity..NTU.            ,
Sal.psu = Salinity..PSU.              ,
NH3_field = Ammonia..mg.l..Field      ,
Chla.phor = Chlorophyll.aquaphor..ug.l.,
Optical.Brightness = Optical.Brightness,
Notes = Notes.                        ,
Salinty.hand = Salinity..handheld.    ,
Turb.hach = Turbidity..hach.
  )%>%
mutate(Month=month(Date),Year=year(Date),Time2=format(strptime(Time, "%Y-%m-%d %H:%M:%S"),"%H:%M"))
```


```{r quals}
names(rawdat)
rawdat2<-rawdat%>%
  select(-c("Samples.collected.by.","Data.entered.by.","Timestamp","Flow.gsec","Notes.","col_types","Time","Hour","Month","Year"))

varit<- c('Monochlorine.mgl','NH4.mgl','NO3.mgl','TN.mgl','Ecoli.100ml','Hour','NO2.mgl','NH3.mgl','OP.mgl','TKN.mgl','Fcoli.100ml', 'Ecoli.100ml')


df_longer<-pivot_longer(rawdat2,any_of(varit),names_to = "Params", values_to = "Result",values_transform=list(Result=as.character))%>%
  dplyr::mutate(disqual = dplyr::case_when(grepl('[<>!EN?]',Result)~1))%>%
  dplyr::mutate(Result=as.numeric(Result))

Quals<-df_longer%>%
        filter(disqual==1)


```









```{r saveit}
timestamp <- Sys.Date()  
filename <- paste0("WS_lab_quals-",timestamp,".rds")  
saveRDS(Quals, file = filename) 

Analysis<-df_longer%>%
        filter(is.na(disqual))
 
filename <- paste0("WS_lab_analysis-",timestamp,".rds")  
saveRDS(Analysis, file = filename) 
```









# Make a descriptive summary table 
options(scipen=999)
sumvars <- Analysis %>%
#   select(
Monochlorine.mgl,NH4.mgl,NO3.mgl,TN.mgl,Flow.gsec,Ecoli.100ml,Hour,NO2.mgl,NH3.mgl,OP.mgl,TKN.mgl,Fcoli.100ml
)%>%
#mutate_at(c('Monochlorine.mgl','NH4.mgl','NO3.mgl','TN.mgl','Flow.gsec','Ecoli.100ml','#Hour','NO2.mgl','NH3.mgl','OP.mgl','TKN.mgl','Fcoli.100ml'), as.numeric)%>% 
   describe(quant=c(.25,.75),na.rm =TRUE) %>%
    as_tibble(rownames="Param")%>%
  select(Param,n,mean,sd,min,median,max)%>%
  kbl(digits=3, caption = paste0(labelit))%>%
  kable_styling()
sumvars


```



Watershed Nutrient Plot

##  Nitrogen Constituents by Site
```{r plotit}

#values - not drawing line

plotit<-doit2 %>%
 mutate_at(c('Monochlorine.mgl','NH4.mgl','NO3.mgl','TN.mgl','Flow.gsec','Ecoli.100ml','Hour','NO2.mgl','NH3.mgl','OP.mgl','TKN.mgl','Fcoli.100ml'), as.numeric)%>%
  pivot_longer(
    cols = c(TN.mgl,NO3.mgl,NO2.mgl,TKN.mgl),
    names_to = "Param",
    values_to = "Conc"
  )%>%
 
#Reorder for plot
 mutate(name = factor(Site.ID, levels=c("Old Man Plaza", "AeropuertoY", "Plant", "P3_out", "P4_out","Bridge", "Turtle Stream", "Coronel Pond")))
         
 
Nuts<-ggplot(plotit, aes(x=name,y=Conc,fill=Param))+
geom_bar(position = "dodge",stat="identity")+
ylab("Concentration (mg/l)") +xlab("Site")+
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1,),
      axis.title.y.left = element_text(colour = "black"),
  #    axis.title.y.right = element_text(colour = "red"),
      )
Nuts

```

Fecal Coliform Plot

```{r plotit2}

plotit2<-doit2 %>%
   mutate_at(c('Ecoli.100ml','Fcoli.100ml'), as.numeric)%>%
    select(Site.ID,Ecoli.100ml, Fcoli.100ml)%>%
  pivot_longer(
    cols = c(Ecoli.100ml, Fcoli.100ml),
    names_to = "Parm",
    values_to = "Conc"
  )%>%
#Reorder for plot
 mutate(name = factor(Site.ID, levels=c("Old Man Plaza", "AeropuertoY", "Plant", "P3_out", "P4_out","Bridge", "Turtle Stream", "Coronel Pond")),Conc2=as.numeric(Conc))

Nuts2<-ggplot(plotit2, aes(x=name,y=Conc2,fill=Parm))+
geom_bar(position = "dodge",stat="identity")+
ylab("Counts (MPN/100ml)") +xlab("Site") +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
      axis.title.y.left = element_text(colour = "black"),
  #    axis.title.y.right = element_text(colour = "red"),
      )
Nuts2


```



